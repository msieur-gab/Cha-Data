<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tea Info Analysis - Debug Mode</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 30px;
            border-bottom: 2px solid #eaecef;
            padding-bottom: 10px;
        }
        h2 {
            color: #2980b9;
            margin-top: 30px;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        button {
            padding: 8px 15px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 20px;
        }
        button:hover {
            background-color: #2980b9;
        }
        .code-block {
            background-color: #f1f3f4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-family: 'Courier New', Courier, monospace;
            margin-bottom: 20px;
        }
        #test-results {
            background-color: white;
            padding: 25px;
            border-radius: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .effect-bar {
            height: 20px;
            background-color: #e9ecef;
            border-radius: 4px;
            margin-bottom: 10px;
            position: relative;
        }
        .effect-bar-fill {
            height: 100%;
            background-color: #3498db;
            border-radius: 4px;
            position: absolute;
            top: 0;
            left: 0;
        }
        .effect-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .small-text {
            font-size: 12px;
            color: #666;
            margin-top: -10px;
            margin-bottom: 10px;
            font-style: italic;
        }
        .tea-info {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .tea-info h4 {
            margin-top: 0;
            color: #2c3e50;
        }
        .tea-info p {
            margin-bottom: 5px;
        }
        .tea-property {
            display: flex;
            justify-content: space-between;
        }
        .tea-property span:first-child {
            font-weight: bold;
        }
        .tea-ratio {
            position: relative;
            height: 24px;
            background-color: #f1f3f4;
            border-radius: 4px;
            margin: 10px 0;
        }
        .l-theanine-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 12px;
            background-color: #27ae60;
            border-radius: 4px;
        }
        .caffeine-bar {
            position: absolute;
            top: 12px;
            left: 0;
            height: 12px;
            background-color: #e74c3c;
            border-radius: 4px;
        }
        pre.markdown {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', Courier, monospace;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        table.timing-data {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        table.timing-data th, table.timing-data td {
            padding: 8px;
            text-align: left;
            border: 1px solid #ddd;
        }
        table.timing-data th {
            background-color: #f1f3f4;
            font-weight: bold;
        }
        
        /* Seasonal Calculator Styles */
        .seasonal-score-bar {
            height: 25px;
            background-color: #e9ecef;
            border-radius: 4px;
            margin-bottom: 15px;
            position: relative;
        }
        .seasonal-score-fill {
            height: 100%;
            border-radius: 4px;
            position: absolute;
            top: 0;
            left: 0;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-weight: bold;
        }
        .spring-fill {
            background-color: #4CAF50; /* Green */
        }
        .summer-fill {
            background-color: #FF9800; /* Orange */
        }
        .fall-fill {
            background-color: #795548; /* Brown */
        }
        .winter-fill {
            background-color: #2196F3; /* Blue */
        }
    </style>
</head>
<body>
    <h1>Tea Analysis System - Debug Mode</h1>
    
    <div>
        <button id="test-interactions">Test Interaction Calculator</button>
        <button id="show-combinations">Show Effect Combinations</button>
        <button id="show-teas">Show Tea Database</button>
        <button id="timing-md-output">Timing Data as Markdown</button>
        <button id="seasonal-md-output">Seasonal Data as Markdown</button>
        <button id="geographic-md-output">Geographic Data as Markdown</button>
    </div>
    
    <div id="test-results">
        <p>Click a button above to run tests and see results.</p>
    </div>
    
    <script type="module">
        import { testInteractionCalculator } from './js/tests/interactionCalculatorTest.js';
        import { mapEffectCombinations } from './js/utils/EffectInteractionMapper.js';
        import { effectCombinations } from './js/props/EffectCombinations.js';
        import { teaDatabase } from './js/TeaDatabase.js';
        import { EffectSystemConfig } from './js/config/EffectSystemConfig.js';
        import { InteractionCalculator } from './js/calculators/InteractionCalculator.js';
        import { flavorInfluences } from './js/props/FlavorInfluences.js';
        import { processingInfluences } from './js/props/ProcessingInfluences.js';
        import { ProcessingCalculator } from './js/calculators/ProcessingCalculator.js';
        import { GeographyCalculator } from './js/calculators/GeographyCalculator.js';
        import { primaryEffects } from './js/props/PrimaryEffects.js';
        import { TimingCalculator } from './js/calculators/TimingCalculator.js';
        import { SeasonCalculator } from './js/calculators/SeasonCalculator.js';
        
        document.getElementById('test-interactions').addEventListener('click', async () => {
            const results = testInteractionCalculator();
            displayResults(results);
        });
        
        document.getElementById('show-combinations').addEventListener('click', async () => {
            const mapped = mapEffectCombinations(effectCombinations);
            displayCombinations(mapped);
        });
        
        document.getElementById('show-teas').addEventListener('click', async () => {
            displayTeaDatabase(teaDatabase);
        });
        
        document.getElementById('timing-md-output').addEventListener('click', async () => {
            displayTimingDataMarkdown();
        });
        
        document.getElementById('seasonal-md-output').addEventListener('click', async () => {
            displaySeasonalDataMarkdown();
        });
        
        document.getElementById('geographic-md-output').addEventListener('click', async () => {
            displayGeographicDataMarkdown();
        });
        
        function displayGeographicDataMarkdown() {
            const calculator = new GeographyCalculator(new EffectSystemConfig());
            
            const sampleTeas = [
                teaDatabase.find(tea => tea.name === "Da Hong Pao"),  // Fujian, China
                teaDatabase.find(tea => tea.name === "Gyokuro"),      // Uji, Japan
                teaDatabase.find(tea => tea.name === "Darjeeling")    // Darjeeling, India
            ];
            
            let html = `<h2>Tea Geographic Data Analysis</h2>`;
            
            sampleTeas.forEach(tea => {
                if (!tea) return;
                
                const geographicData = calculator.getGeographicAnalysis(tea.origin);
                
                html += `
                    <h3>${tea.name} - ${tea.origin}</h3>
                    <div style="display: flex; gap: 20px;">
                        <div style="flex: 0 0 300px;">
                            ${renderTeaInfo(tea)}
                        </div>
                        <div style="flex: 1;">
                            <h4>Markdown Raw Data</h4>
                            <pre class="markdown">${generateGeographicMarkdown(tea, geographicData, calculator)}</pre>
                        </div>
                    </div>
                    
                    <h4>Geographic Information</h4>
                    <table class="timing-data">
                        <thead>
                            <tr>
                                <th>Geographic Factor</th>
                                <th>Value</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Region</td>
                                <td>${geographicData.region !== 'unknown' ? geographicData.region : 'Not specified'}</td>
                                <td>${geographicData.regionSignature ? 'Signature: ' + geographicData.regionSignature : ''}</td>
                            </tr>
                            <tr>
                                <td>Elevation</td>
                                <td>${geographicData.elevation}m (${geographicData.elevationCategory})</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td>Latitude</td>
                                <td>${geographicData.latitude !== null ? geographicData.latitude + '° (' + geographicData.latitudeZone + ')' : 'Not specified'}</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td>Terrain</td>
                                <td>${geographicData.features.join(', ')}</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td>Soil Type</td>
                                <td>${geographicData.soilType || 'Not specified'}</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td>Climate</td>
                                <td>${geographicData.climate || 'Not specified'}</td>
                                <td></td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <h4>Famous Tea Styles from this Region</h4>
                    ${geographicData.famousStyles ? 
                        `<p>${geographicData.famousStyles.join(', ')}</p>` : 
                        '<p>No specific styles listed for this region</p>'}
                    
                    <h4>Seasonal Variations in this Region</h4>
                    ${geographicData.seasonality ? 
                        `<table class="timing-data">
                            <thead>
                                <tr>
                                    <th>Season</th>
                                    <th>Characteristics</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(geographicData.seasonality).map(([season, desc]) => `
                                    <tr>
                                        <td>${season.charAt(0).toUpperCase() + season.slice(1)}</td>
                                        <td>${desc}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>` : 
                        '<p>No seasonal data available for this region</p>'}
                    
                    <h4>Geographic Effects on Tea Character</h4>
                    <table class="timing-data">
                        <thead>
                            <tr>
                                <th>Effect</th>
                                <th>Score</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(geographicData.effects)
                                .sort((a, b) => b[1] - a[1])
                                .map(([effect, score]) => `
                                    <tr>
                                        <td>${effect}</td>
                                        <td>${score.toFixed(1)}</td>
                                    </tr>
                                `).join('')}
                        </tbody>
                    </table>
                    
                    <h4>Geographic Description</h4>
                    <p>${geographicData.description}</p>
                    
                    <h4>Calculation Code</h4>
                    <pre style="white-space: pre-wrap; background-color: #f8f9fa; padding: 15px; border-radius: 5px;">
${calculator.getEffectsCalculationText(tea.origin)}
                    </pre>
                `;
            });
            
            document.getElementById('test-results').innerHTML = html;
        }
        
        function generateGeographicMarkdown(tea, geographicData, calculator) {
            let markdown = `# ${tea.name} Geographic Analysis\n\n`;
            
            markdown += `## Tea Origin: ${tea.origin}\n\n`;
            
            markdown += `## Geographic Factors\n`;
            markdown += `- **Region:** ${geographicData.region !== 'unknown' ? geographicData.region : 'Not specified'}\n`;
            markdown += `- **Elevation:** ${geographicData.elevation}m (${geographicData.elevationCategory})\n`;
            markdown += `- **Latitude:** ${geographicData.latitude !== null ? geographicData.latitude + '° (' + geographicData.latitudeZone + ')' : 'Not specified'}\n`;
            markdown += `- **Terrain:** ${geographicData.features.join(', ')}\n`;
            markdown += `- **Soil Type:** ${geographicData.soilType || 'Not specified'}\n`;
            markdown += `- **Climate:** ${geographicData.climate || 'Not specified'}\n\n`;
            
            if (geographicData.regionSignature) {
                markdown += `## Region Signature\n`;
                markdown += `${geographicData.regionSignature}\n\n`;
            }
            
            if (geographicData.famousStyles && geographicData.famousStyles.length > 0) {
                markdown += `## Famous Tea Styles from this Region\n`;
                markdown += `${geographicData.famousStyles.join(', ')}\n\n`;
            }
            
            if (geographicData.seasonality) {
                markdown += `## Seasonal Variations\n`;
                Object.entries(geographicData.seasonality).forEach(([season, desc]) => {
                    markdown += `- **${season.charAt(0).toUpperCase() + season.slice(1)}**: ${desc}\n`;
                });
                markdown += '\n';
            }
            
            markdown += `## Geographic Effects on Tea Character\n`;
            Object.entries(geographicData.effects)
                .sort((a, b) => b[1] - a[1])
                .forEach(([effect, score]) => {
                    markdown += `- **${effect}**: ${score.toFixed(1)}\n`;
                });
            markdown += '\n';
            
            markdown += `## Description\n\n${geographicData.description}\n\n`;
            
            markdown += `## Technical Analysis\n\`\`\`javascript\n${calculator.getEffectsCalculationText(tea.origin)}\n\`\`\``;
            
            return markdown;
        }
        
        document.getElementById('test-interactions').addEventListener('click', async () => {
            const results = testInteractionCalculator();
            displayResults(results);
        });
        
        document.getElementById('show-combinations').addEventListener('click', async () => {
            const mapped = mapEffectCombinations(effectCombinations);
            displayCombinations(mapped);
        });
        
        document.getElementById('show-teas').addEventListener('click', async () => {
            displayTeaDatabase(teaDatabase);
        });
        
        document.getElementById('timing-md-output').addEventListener('click', async () => {
            displayTimingDataMarkdown();
        });
        
        document.getElementById('seasonal-md-output').addEventListener('click', async () => {
            displaySeasonalDataMarkdown();
        });
        
        function displaySeasonalDataMarkdown() {
            const calculator = new SeasonCalculator(new EffectSystemConfig(), primaryEffects);
            
            const sampleTeas = [
                teaDatabase.find(tea => tea.name === "Gyokuro"),
                teaDatabase.find(tea => tea.name === "Assam"),
                teaDatabase.find(tea => tea.name === "Da Hong Pao")
            ];
            
            let html = `<h2>Tea Seasonal Data - Best Seasons Analysis</h2>`;
            
            sampleTeas.forEach(tea => {
                if (!tea) return;
                
                const seasonalData = calculator.calculateSeasonalSuitability(tea);
                
                html += `
                    <h3>${tea.name} (${tea.type})</h3>
                    <div style="display: flex; gap: 20px;">
                        <div style="flex: 0 0 300px;">
                            ${renderTeaInfo(tea)}
                        </div>
                        <div style="flex: 1;">
                            <h4>Markdown Raw Data</h4>
                            <pre class="markdown">${generateSeasonalMarkdown(tea, seasonalData)}</pre>
                        </div>
                    </div>
                    
                    <h4>Seasonal Suitability Scores</h4>
                    <div style="max-width: 600px;">
                        ${renderSeasonalScoreBars(seasonalData.scores)}
                    </div>
                    
                    <h4>Season Ranking</h4>
                    <table class="timing-data">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Season</th>
                                <th>Score</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${seasonalData.bestSeasons.map((data, index) => `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${data.season.charAt(0).toUpperCase() + data.season.slice(1)}</td>
                                    <td>${data.score.toFixed(1)}/10</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <h4>Seasonal Explanations</h4>
                    <div style="margin-bottom: 20px;">
                        <p><strong>General:</strong> ${seasonalData.explanations.general}</p>
                        ${Object.entries(seasonalData.explanations)
                            .filter(([key]) => key !== 'general' && key !== 'scientific')
                            .map(([season, explanation]) => `
                                <p><strong>${season.charAt(0).toUpperCase() + season.slice(1)}:</strong> ${explanation}</p>
                            `).join('')}
                    </div>
                    
                    <h4>Scientific Basis</h4>
                    <pre style="white-space: pre-wrap; background-color: #f8f9fa; padding: 15px; border-radius: 5px;">
${seasonalData.explanations.scientific}
                    </pre>
                `;
            });
            
            document.getElementById('test-results').innerHTML = html;
        }
        
        function renderSeasonalScoreBars(scores) {
            return `
                <div style="margin-bottom: 20px;">
                    <div class="effect-label">
                        <span>Spring</span>
                        <span>${scores.spring.toFixed(1)}/10</span>
                    </div>
                    <div class="seasonal-score-bar">
                        <div class="seasonal-score-fill spring-fill" style="width: ${scores.spring * 10}%">${scores.spring.toFixed(1)}</div>
                    </div>
                    
                    <div class="effect-label">
                        <span>Summer</span>
                        <span>${scores.summer.toFixed(1)}/10</span>
                    </div>
                    <div class="seasonal-score-bar">
                        <div class="seasonal-score-fill summer-fill" style="width: ${scores.summer * 10}%">${scores.summer.toFixed(1)}</div>
                    </div>
                    
                    <div class="effect-label">
                        <span>Fall</span>
                        <span>${scores.fall.toFixed(1)}/10</span>
                    </div>
                    <div class="seasonal-score-bar">
                        <div class="seasonal-score-fill fall-fill" style="width: ${scores.fall * 10}%">${scores.fall.toFixed(1)}</div>
                    </div>
                    
                    <div class="effect-label">
                        <span>Winter</span>
                        <span>${scores.winter.toFixed(1)}/10</span>
                    </div>
                    <div class="seasonal-score-bar">
                        <div class="seasonal-score-fill winter-fill" style="width: ${scores.winter * 10}%">${scores.winter.toFixed(1)}</div>
                    </div>
                </div>
            `;
        }
        
        function generateSeasonalMarkdown(tea, seasonalData) {
            let markdown = `# ${tea.name} Seasonal Analysis\n\n`;
            
            markdown += `## Tea Properties\n`;
            markdown += `- Type: ${tea.type}\n`;
            markdown += `- L-Theanine: ${tea.lTheanineLevel}/10\n`;
            markdown += `- Caffeine: ${tea.caffeineLevel}/10\n`;
            markdown += `- Ratio: ${(tea.lTheanineLevel / tea.caffeineLevel).toFixed(2)}:1\n\n`;
            
            markdown += `## Seasonal Suitability Scores\n`;
            markdown += `- Spring: ${seasonalData.scores.spring.toFixed(1)}/10\n`;
            markdown += `- Summer: ${seasonalData.scores.summer.toFixed(1)}/10\n`;
            markdown += `- Fall: ${seasonalData.scores.fall.toFixed(1)}/10\n`;
            markdown += `- Winter: ${seasonalData.scores.winter.toFixed(1)}/10\n\n`;
            
            markdown += `## Best Seasons Ranking\n`;
            seasonalData.bestSeasons.forEach((data, index) => {
                markdown += `${index + 1}. **${data.season.charAt(0).toUpperCase() + data.season.slice(1)}** - Score: ${data.score.toFixed(1)}/10\n`;
            });
            markdown += '\n';
            
            markdown += `## Seasonal Explanations\n\n`;
            markdown += `**General:** ${seasonalData.explanations.general}\n\n`;
            
            Object.entries(seasonalData.explanations)
                .filter(([key]) => key !== 'general' && key !== 'scientific')
                .forEach(([season, explanation]) => {
                    markdown += `**${season.charAt(0).toUpperCase() + season.slice(1)}:** ${explanation}\n\n`;
                });
            
            markdown += `## Scientific Basis\n\n${seasonalData.explanations.scientific}`;
            
            return markdown;
        }
        
        function displayTimingDataMarkdown() {
            const calculator = new TimingCalculator(new EffectSystemConfig(), primaryEffects);
            
            const sampleTeas = [
                teaDatabase.find(tea => tea.name === "Gyokuro"),
                teaDatabase.find(tea => tea.name === "Assam"),
                teaDatabase.find(tea => tea.name === "Da Hong Pao")
            ];
            
            let html = `<h2>Tea Timing Data - Raw Calculator Output</h2>`;
            
            sampleTeas.forEach(tea => {
                if (!tea) return;
                
                const timingData = calculator.calculate(tea);
                
                html += `
                    <h3>${tea.name} (${tea.type})</h3>
                    <div style="display: flex; gap: 20px;">
                        <div style="flex: 0 0 300px;">
                            ${renderTeaInfo(tea)}
                        </div>
                        <div style="flex: 1;">
                            <h4>Markdown Raw Data</h4>
                            <pre class="markdown">${generateTimingMarkdown(tea, timingData.data)}</pre>
                        </div>
                    </div>
                    
                    <h4>Best Drinking Times</h4>
                    <table class="timing-data">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Time Range</th>
                                <th>Score</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${timingData.bestTimes.map((time, index) => `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${time.timeRange}</td>
                                    <td>${time.avgScore.toFixed(1)}/10</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <h4>Hourly Scores</h4>
                    <table class="timing-data">
                        <thead>
                            <tr>
                                <th>Hour</th>
                                <th>Score</th>
                                <th>Hour</th>
                                <th>Score</th>
                                <th>Hour</th>
                                <th>Score</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${generateHourlyScoresTable(timingData.timeScores)}
                        </tbody>
                    </table>
                `;
            });
            
            document.getElementById('test-results').innerHTML = html;
        }
        
        function generateTimingMarkdown(tea, timingData) {
            let markdown = `# ${tea.name} Timing Analysis\n\n`;
            
            markdown += `## Tea Properties\n`;
            markdown += `- Type: ${tea.type}\n`;
            markdown += `- L-Theanine: ${tea.lTheanineLevel}/10\n`;
            markdown += `- Caffeine: ${tea.caffeineLevel}/10\n`;
            markdown += `- Ratio: ${(tea.lTheanineLevel / tea.caffeineLevel).toFixed(2)}:1\n\n`;
            
            markdown += `## Best Drinking Times\n`;
            timingData.bestTimes.forEach((time, index) => {
                markdown += `${index + 1}. **${time.timeRange}** - Score: ${time.avgScore.toFixed(1)}/10\n`;
            });
            markdown += '\n';
            
            markdown += `## Hourly Suitability Scores\n`;
            markdown += `\`\`\`\n`;
            markdown += `Hour | Score | Hour | Score | Hour | Score\n`;
            markdown += `---- | ----- | ---- | ----- | ---- | -----\n`;
            
            const hours = Object.keys(timingData.timeScores).sort((a, b) => parseInt(a) - parseInt(b));
            const chunks = [];
            
            for (let i = 0; i < hours.length; i += 3) {
                chunks.push(hours.slice(i, i + 3));
            }
            
            chunks.forEach(chunk => {
                let row = '';
                chunk.forEach(hour => {
                    const formattedHour = formatHour(parseInt(hour));
                    const score = timingData.timeScores[hour].toFixed(1);
                    row += `${formattedHour} | ${score} | `;
                });
                markdown += row.slice(0, -3) + '\n';
            });
            
            markdown += `\`\`\`\n\n`;
            
            markdown += `## Scientific Explanation\n\n${timingData.explanation}`;
            
            return markdown;
        }
        
        function formatHour(hour) {
            const period = hour < 12 ? 'AM' : 'PM';
            const displayHour = hour % 12 === 0 ? 12 : hour % 12;
            return `${displayHour}${period}`;
        }
        
        function generateHourlyScoresTable(timeScores) {
            const hours = Object.keys(timeScores).sort((a, b) => parseInt(a) - parseInt(b));
            const chunks = [];
            
            for (let i = 0; i < hours.length; i += 3) {
                chunks.push(hours.slice(i, i + 3));
            }
            
            let tableHtml = '';
            chunks.forEach(chunk => {
                tableHtml += '<tr>';
                chunk.forEach(hour => {
                    const formattedHour = formatHour(parseInt(hour));
                    const score = timeScores[hour].toFixed(1);
                    tableHtml += `<td>${formattedHour}</td><td>${score}</td>`;
                });
                
                for (let i = chunk.length; i < 3; i++) {
                    tableHtml += '<td></td><td></td>';
                }
                
                tableHtml += '</tr>';
            });
            
            return tableHtml;
        }
        
        function displayResults(results) {
            const { 
                testScores1, 
                modifiedScores1, 
                gyokuroScores, 
                modifiedGyokuroScores,
                assamScores,
                modifiedAssamScores, 
                gyokuroInteractions 
            } = results;
            
            const gyokuro = teaDatabase.find(tea => tea.name === "Gyokuro");
            const assam = teaDatabase.find(tea => tea.name === "Assam");
            
            let html = `
                <h2>Test Case 1: Custom Effect Interaction</h2>
                <div style="display: flex; gap: 30px;">
                    <div style="flex: 1;">
                        <h3>Base Effects</h3>
                        <p class="small-text">Individual effects before synergy</p>
                        ${renderScores(testScores1)}
                    </div>
                    <div style="flex: 1;">
                        <h3>Synergistic Effects</h3>
                        <p class="small-text">After applying interactions</p>
                        ${renderScores(modifiedScores1)}
                    </div>
                </div>
                
                <h2>Test Case 2: Gyokuro Effect Interactions</h2>
                ${renderTeaInfo(gyokuro)}
                <div style="display: flex; gap: 30px;">
                    <div style="flex: 1;">
                        <h3>Base Effects</h3>
                        <p class="small-text">Individual effects before synergy</p>
                        ${renderScores(gyokuroScores)}
                    </div>
                    <div style="flex: 1;">
                        <h3>Synergistic Effects</h3>
                        <p class="small-text">After applying interactions</p>
                        ${renderScores(modifiedGyokuroScores)}
                    </div>
                </div>
                
                <h2>Test Case 3: Assam Effect Interactions</h2>
                ${renderTeaInfo(assam)}
                <div style="display: flex; gap: 30px;">
                    <div style="flex: 1;">
                        <h3>Base Effects</h3>
                        <p class="small-text">Individual effects before synergy</p>
                        ${renderScores(assamScores)}
                    </div>
                    <div style="flex: 1;">
                        <h3>Synergistic Effects</h3>
                        <p class="small-text">After applying interactions</p>
                        ${renderScores(modifiedAssamScores)}
                    </div>
                </div>
                
                <h2>Test Case 4: Significant Interactions</h2>
                <h3>Gyokuro Synergistic Interactions</h3>
                ${gyokuroInteractions.length > 0 ? 
                    gyokuroInteractions.map(interaction => `
                        <div style="margin-bottom: 20px;">
                            <h4>${interaction.name || interaction.effects.join(' + ')}</h4>
                            <p><strong>Strength:</strong> ${interaction.strength.toFixed(2)}</p>
                            <p>${interaction.description}</p>
                            ${interaction.modifies && interaction.modifies.length > 0 ? `
                                <p><strong>Modifies:</strong></p>
                                <ul>
                                    ${interaction.modifies.map(mod => `
                                        <li>${mod.target}: ${mod.modifier > 0 ? '+' : ''}${mod.modifier}</li>
                                    `).join('')}
                                </ul>
                            ` : ''}
                        </div>
                    `).join('') : 
                    '<p>No significant interactions found.</p>'
                }
            `;
            
            document.getElementById('test-results').innerHTML = html;
        }
        
        function displayCombinations(combinations) {
            let html = `<h2>Mapped Effect Combinations</h2>`;
            
            const totalCount = Object.keys(combinations).length;
            html += `<p>Total combinations: ${totalCount}</p>`;
            
            const firstFive = Object.entries(combinations).slice(0, 5);
            
            html += `<h3>Sample Combinations (First 5)</h3>`;
            html += firstFive.map(([key, combination]) => `
                <div style="margin-bottom: 30px; padding: 15px; border: 1px solid #eee; border-radius: 5px;">
                    <h4>${key} → ${combination.name}</h4>
                    <p>${combination.description}</p>
                    <p><strong>Effects:</strong> ${combination.effects.join(', ')}</p>
                    ${combination.modifies ? `
                        <p><strong>Modifies:</strong></p>
                        <ul>
                            ${combination.modifies.map(mod => `
                                <li>${mod.target}: ${mod.modifier > 0 ? '+' : ''}${mod.modifier}</li>
                            `).join('')}
                        </ul>
                    ` : '<p>No modifiers defined.</p>'}
                </div>
            `).join('');
            
            document.getElementById('test-results').innerHTML = html;
        }
        
        function displayTeaDatabase(teas) {
            const config = new EffectSystemConfig();
            const mappedCombinations = mapEffectCombinations(effectCombinations);
            const calculator = new InteractionCalculator(config, mappedCombinations);
            const processingCalculator = new ProcessingCalculator(config, processingInfluences);
            const geographyCalculator = new GeographyCalculator(config);
            
            let html = `
                <h2>Tea Analysis Process Documentation</h2>
                <div class="code-block" style="white-space: pre-wrap; font-family: monospace; line-height: 1.5;">
# Tea Analysis Process
> Debugging notebook showing each step of tea effect calculation

## Files Used
- TeaDatabase.js - Source data for teas
- EffectCombinations.js - Effect combination definitions
- EffectInteractionMapper.js - Maps combinations to add modifiers
- InteractionCalculator.js - Calculates synergistic effects
- EffectSystemConfig.js - Configuration parameters
- FlavorInfluences.js - Mappings of flavors to effect influences
- ProcessingInfluences.js - Mappings of processing methods to effect influences
- ProcessingCalculator.js - Calculates processing method effects

## Process Overview
1. Tea properties are loaded from TeaDatabase.js
2. Base effects are calculated from tea attributes:
   - Expected effects (dominant/supporting)
   - L-Theanine/Caffeine ratio effects
   - Processing method effects
   - Flavor influences (flavor profile)
   - Geographical influences (origin region)
   - Compound factors (beyond L-Theanine/Caffeine ratio)
3. Effect combinations are loaded and mapped with modifiers
4. Synergistic effects are calculated by evaluateSynergisticEffects()
5. Results are compared with expected effects

## Configuration Parameters
\`\`\`javascript
// from defaultConfig.js
interactionStrengthFactor: ${config.get('interactionStrengthFactor')}
supportingEffectThreshold: ${config.get('supportingEffectThreshold')}
\`\`\`

## Individual Tea Analysis
</div>`;
            
            teas.forEach(tea => {
                const scoreContributions = {};
                const trackScore = (source, effect, value) => {
                    if (!scoreContributions[effect]) {
                        scoreContributions[effect] = {};
                    }
                    scoreContributions[effect][source] = value;
                };
                
                if (tea.expectedEffects?.dominant) {
                    trackScore('expected', tea.expectedEffects.dominant, 8.5);
                }
                if (tea.expectedEffects?.supporting) {
                    trackScore('expected', tea.expectedEffects.supporting, 6.5);
                }
                
                const ratio = tea.lTheanineLevel / tea.caffeineLevel;
                if (ratio > 1.5) {
                    const peacefulValue = Math.min(10, tea.lTheanineLevel * 0.8);
                    const soothingValue = Math.min(10, tea.lTheanineLevel * 0.7);
                    trackScore('ratio', 'peaceful', peacefulValue);
                    trackScore('ratio', 'soothing', soothingValue);
                }
                if (ratio < 1.0) {
                    const revitalizingValue = Math.min(10, tea.caffeineLevel * 0.9);
                    const awakeningValue = Math.min(10, tea.caffeineLevel * 0.7);
                    trackScore('ratio', 'revitalizing', revitalizingValue);
                    trackScore('ratio', 'awakening', awakeningValue);
                }
                
                const geographyScores = geographyCalculator.calculateGeographicEffects(tea.origin);
                Object.entries(geographyScores).forEach(([effect, value]) => {
                    trackScore('geography', effect, value);
                });
                
                const geographicAnalysis = geographyCalculator.getGeographicAnalysis(tea.origin);
                
                const compoundScores = calculateCompoundEffects(tea);
                Object.entries(compoundScores).forEach(([effect, value]) => {
                    trackScore('compound', effect, value);
                });
                
                const processingScores = processingCalculator.calculateProcessingInfluence(tea);
                Object.entries(processingScores).forEach(([effect, value]) => {
                    trackScore('processing', effect, value);
                });
                
                const processingDetails = processingCalculator.getProcessingDetails(tea.processingMethods);
                
                const flavorContributions = calculateFlavorContributions(tea.flavorProfile);
                Object.entries(flavorContributions).forEach(([effect, value]) => {
                    trackScore('flavor', effect, value);
                });
                
                const calculatedScores = {};
                Object.entries(scoreContributions).forEach(([effect, sources]) => {
                    calculatedScores[effect] = Object.values(sources).reduce((sum, value) => sum + value, 0);
                    calculatedScores[effect] = Math.min(10, Math.max(0, calculatedScores[effect]));
                });
                
                const synergisticScores = calculator.evaluateSynergisticEffects(calculatedScores);
                
                const synergisticContributions = {};
                Object.entries(synergisticScores).forEach(([effect, score]) => {
                    const baseScore = calculatedScores[effect] || 0;
                    synergisticContributions[effect] = score - baseScore;
                });
                
                const topSynergisticEffects = Object.entries(synergisticScores)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 3);
                
                const significantInteractions = calculator.identifySignificantInteractions(calculatedScores);
                
                const contributionTable = `
<table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
  <thead>
    <tr style="background-color: #f1f3f4;">
      <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Effect</th>
      <th style="padding: 8px; text-align: right; border: 1px solid #ddd;">Expected</th>
      <th style="padding: 8px; text-align: right; border: 1px solid #ddd;">Ratio</th>
      <th style="padding: 8px; text-align: right; border: 1px solid #ddd;">Geography</th>
      <th style="padding: 8px; text-align: right; border: 1px solid #ddd;">Compounds</th>
      <th style="padding: 8px; text-align: right; border: 1px solid #ddd;">Processing</th>
      <th style="padding: 8px; text-align: right; border: 1px solid #ddd;">Flavor</th>
      <th style="padding: 8px; text-align: right; border: 1px solid #ddd;">Base Total</th>
      <th style="padding: 8px; text-align: right; border: 1px solid #ddd;">Synergy</th>
      <th style="padding: 8px; text-align: right; border: 1px solid #ddd;">Final</th>
    </tr>
  </thead>
  <tbody>
    ${Object.entries(synergisticScores)
      .sort((a, b) => b[1] - a[1])
      .map(([effect, finalScore]) => {
        const sources = scoreContributions[effect] || {};
        const expectedValue = sources.expected || 0;
        const ratioValue = sources.ratio || 0;
        const geographyValue = sources.geography || 0;
        const compoundValue = sources.compound || 0;
        const processingValue = sources.processing || 0;
        const flavorValue = sources.flavor || 0;
        const baseTotal = calculatedScores[effect] || 0;
        const synergy = synergisticContributions[effect] || 0;
        
        return `
          <tr>
            <td style="padding: 8px; text-align: left; border: 1px solid #ddd;">${effect}</td>
            <td style="padding: 8px; text-align: right; border: 1px solid #ddd;">${expectedValue.toFixed(1)}</td>
            <td style="padding: 8px; text-align: right; border: 1px solid #ddd;">${ratioValue.toFixed(1)}</td>
            <td style="padding: 8px; text-align: right; border: 1px solid #ddd;">${geographyValue.toFixed(1)}</td>
            <td style="padding: 8px; text-align: right; border: 1px solid #ddd;">${compoundValue.toFixed(1)}</td>
            <td style="padding: 8px; text-align: right; border: 1px solid #ddd;">${processingValue.toFixed(1)}</td>
            <td style="padding: 8px; text-align: right; border: 1px solid #ddd;">${flavorValue.toFixed(1)}</td>
            <td style="padding: 8px; text-align: right; border: 1px solid #ddd;">${baseTotal.toFixed(1)}</td>
            <td style="padding: 8px; text-align: right; border: 1px solid #ddd; ${synergy !== 0 ? 'color: ' + (synergy > 0 ? 'green' : 'red') : ''}">${synergy !== 0 ? (synergy > 0 ? '+' : '') + synergy.toFixed(1) : '0.0'}</td>
            <td style="padding: 8px; text-align: right; border: 1px solid #ddd; font-weight: bold;">${finalScore.toFixed(1)}</td>
          </tr>
        `;
      }).join('')}
  </tbody>
</table>`;

                const geographyTable = `
<table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
  <thead>
    <tr style="background-color: #f1f3f4;">
      <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Origin</th>
      <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Elevation</th>
      <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Latitude</th>
      <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Features</th>
      <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Effects</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="padding: 8px; text-align: left; border: 1px solid #ddd;">${tea.origin}</td>
      <td style="padding: 8px; text-align: left; border: 1px solid #ddd;">${geographicAnalysis.elevation}m (${geographicAnalysis.elevationCategory})</td>
      <td style="padding: 8px; text-align: left; border: 1px solid #ddd;">${geographicAnalysis.latitude ? `${geographicAnalysis.latitude}° (${geographicAnalysis.latitudeZone})` : 'Unknown'}</td>
      <td style="padding: 8px; text-align: left; border: 1px solid #ddd;">${geographicAnalysis.features.join(', ')}</td>
      <td style="padding: 8px; text-align: left; border: 1px solid #ddd;">
        ${Object.entries(geographyScores)
          .sort((a, b) => b[1] - a[1])
          .map(([effect, value]) => `${effect} (${value.toFixed(1)})`)
          .join(', ')}
      </td>
    </tr>
  </tbody>
</table>`;

                const geographyDescriptionTable = `
<table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
  <thead>
    <tr style="background-color: #f1f3f4;">
      <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Geographic Analysis</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="padding: 8px; text-align: left; border: 1px solid #ddd;">${geographicAnalysis.description}</td>
    </tr>
    ${geographicAnalysis.soilType || geographicAnalysis.climate ? `
    <tr>
      <td style="padding: 8px; text-align: left; border: 1px solid #ddd;">
        ${geographicAnalysis.soilType ? `<strong>Soil:</strong> ${geographicAnalysis.soilType}` : ''}
        ${geographicAnalysis.soilType && geographicAnalysis.climate ? ' | ' : ''}
        ${geographicAnalysis.climate ? `<strong>Climate:</strong> ${geographicAnalysis.climate}` : ''}
      </td>
    </tr>` : ''}
  </tbody>
</table>`;

                const compoundTable = `
<table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
  <thead>
    <tr style="background-color: #f1f3f4;">
      <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Compound Factor</th>
      <th style="padding: 8px; text-align: right; border: 1px solid #ddd;">Value</th>
      <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Effects</th>
      <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="padding: 8px; text-align: left; border: 1px solid #ddd;">L-Theanine/Caffeine Ratio</td>
      <td style="padding: 8px; text-align: right; border: 1px solid #ddd;">${ratio.toFixed(2)}</td>
      <td style="padding: 8px; text-align: left; border: 1px solid #ddd;">
        ${ratio > 1.5 ? 'peaceful, soothing' : (ratio < 1.0 ? 'revitalizing, awakening' : 'balanced')}
      </td>
      <td style="padding: 8px; text-align: left; border: 1px solid #ddd;">
        ${getRatioDescription(ratio)}
      </td>
    </tr>
    <tr>
      <td style="padding: 8px; text-align: left; border: 1px solid #ddd;">Total Polyphenol Estimate</td>
      <td style="padding: 8px; text-align: right; border: 1px solid #ddd;">${estimatePolyphenols(tea).toFixed(1)}/10</td>
      <td style="padding: 8px; text-align: left; border: 1px solid #ddd;">
        ${Object.entries(calculateCompoundEffects(tea))
          .filter(([effect, _]) => effect === 'clarifying' || effect === 'restorative')
          .map(([effect, value]) => `${effect} (${value.toFixed(1)})`)
          .join(', ')}
      </td>
      <td style="padding: 8px; text-align: left; border: 1px solid #ddd;">
        ${getPolyphenolDescription(estimatePolyphenols(tea))}
      </td>
    </tr>
    <tr>
      <td style="padding: 8px; text-align: left; border: 1px solid #ddd;">Amino Acid Profile</td>
      <td style="padding: 8px; text-align: right; border: 1px solid #ddd;">${estimateAminoAcids(tea).toFixed(1)}/10</td>
      <td style="padding: 8px; text-align: left; border: 1px solid #ddd;">
        ${Object.entries(calculateCompoundEffects(tea))
          .filter(([effect, _]) => effect === 'soothing' || effect === 'nurturing')
          .map(([effect, value]) => `${effect} (${value.toFixed(1)})`)
          .join(', ')}
      </td>
      <td style="padding: 8px; text-align: left; border: 1px solid #ddd;">
        ${getAminoAcidDescription(estimateAminoAcids(tea))}
      </td>
    </tr>
  </tbody>
</table>`;

                const flavorDetails = getFlavorDetails(tea.flavorProfile);
                const flavorContributionsTable = `
<table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
  <thead>
    <tr style="background-color: #f1f3f4;">
      <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Flavor</th>
      <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Category/Subcategory</th>
      <th style="padding: 8px; text-align: right; border: 1px solid #ddd;">Intensity</th>
      <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Effects</th>
    </tr>
  </thead>
  <tbody>
    ${flavorDetails.length > 0 ? 
      flavorDetails.map(flavor => `
        <tr>
          <td style="padding: 8px; text-align: left; border: 1px solid #ddd;">${flavor.name}</td>
          <td style="padding: 8px; text-align: left; border: 1px solid #ddd;">${flavor.category}/${flavor.subcategory}</td>
          <td style="padding: 8px; text-align: right; border: 1px solid #ddd;">${flavor.intensity.toFixed(1)}</td>
          <td style="padding: 8px; text-align: left; border: 1px solid #ddd;">${flavor.effects.join(', ')}</td>
        </tr>
      `).join('') : 
      `<tr><td colspan="4" style="padding: 8px; text-align: center; border: 1px solid #ddd;">No flavor details available</td></tr>`}
  </tbody>
</table>`;

                const processingTable = `
<table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
  <thead>
    <tr style="background-color: #f1f3f4;">
      <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Processing Method</th>
      <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Category</th>
      <th style="padding: 8px; text-align: right; border: 1px solid #ddd;">Intensity</th>
      <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Primary Effects</th>
      <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Description</th>
    </tr>
  </thead>
  <tbody>
    ${processingDetails.length > 0 ? 
      processingDetails.map(detail => `
        <tr>
          <td style="padding: 8px; text-align: left; border: 1px solid #ddd;">${detail.method}</td>
          <td style="padding: 8px; text-align: left; border: 1px solid #ddd;">${detail.category}</td>
          <td style="padding: 8px; text-align: right; border: 1px solid #ddd;">${detail.intensity.toFixed(1)}</td>
          <td style="padding: 8px; text-align: left; border: 1px solid #ddd;">
            ${Object.entries(detail.effects)
              .sort((a, b) => b[1] - a[1])
              .slice(0, 3)
              .map(([effect, strength]) => `${effect} (${strength.toFixed(1)})`)
              .join(', ')}
          </td>
          <td style="padding: 8px; text-align: left; border: 1px solid #ddd;">${detail.description}</td>
        </tr>
      `).join('') : 
      `<tr><td colspan="5" style="padding: 8px; text-align: center; border: 1px solid #ddd;">No processing details available</td></tr>`}
  </tbody>
</table>`;

                const interactionsTable = significantInteractions.length > 0 ? `
<table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
  <thead>
    <tr style="background-color: #f1f3f4;">
      <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Interaction</th>
      <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Strength</th>
      <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Modified Effects</th>
    </tr>
  </thead>
  <tbody>
    ${significantInteractions.map(interaction => {
        const effect1 = interaction.effects[0];
        const effect2 = interaction.effects[1];
        const score1 = calculatedScores[effect1] || 0;
        const score2 = calculatedScores[effect2] || 0;
        
        let modifiedEffects = '';
        if (interaction.modifies && interaction.modifies.length > 0) {
            modifiedEffects = interaction.modifies.map(mod => 
                `${mod.target}: ${mod.modifier > 0 ? '+' : ''}${(interaction.strength * mod.modifier).toFixed(2)}`
            ).join('<br>');
        } else {
            modifiedEffects = `${effect1}: +${(interaction.strength * 0.2).toFixed(2)}<br>${effect2}: +${(interaction.strength * 0.2).toFixed(2)}`;
        }
        
        return `
          <tr>
            <td style="padding: 8px; text-align: left; border: 1px solid #ddd;">${effect1} (${score1.toFixed(1)}) + ${effect2} (${score2.toFixed(1)})<br><em>${interaction.name}</em></td>
            <td style="padding: 8px; text-align: left; border: 1px solid #ddd;">${interaction.strength.toFixed(2)}</td>
            <td style="padding: 8px; text-align: left; border: 1px solid #ddd;">${modifiedEffects}</td>
          </tr>
        `;
    }).join('')}
  </tbody>
</table>` : `<p>No significant interactions detected</p>`;

                const highRatioEffects = ratio > 1.5 ? 
                    `// High L-Theanine ratio (${ratio.toFixed(1)} > 1.5)
scores['peaceful'] += Math.min(10, ${tea.lTheanineLevel} * 0.8);
scores['soothing'] += Math.min(10, ${tea.lTheanineLevel} * 0.7);` : 
                    '// L-Theanine ratio not high enough for peaceful/soothing boost';
                    
                const lowRatioEffects = ratio < 1.0 ? 
                    `// Low L-Theanine ratio (${ratio.toFixed(1)} < 1.0)
scores['revitalizing'] += Math.min(10, ${tea.caffeineLevel} * 0.9);
scores['awakening'] += Math.min(10, ${tea.caffeineLevel} * 0.7);` : 
                    '// L-Theanine ratio not low enough for revitalizing/awakening boost';
                    
                const processingEffects = [];
                processingDetails.forEach(detail => {
                    const effectsText = Object.entries(detail.effects)
                        .sort((a, b) => b[1] - a[1])
                        .map(([effect, strength]) => `${effect}: ${strength.toFixed(1)}`)
                        .join(', ');
                    
                    processingEffects.push(
                        `// ${detail.method} (${detail.category}, intensity: ${detail.intensity.toFixed(1)})` + 
                        `\n// Effects: ${effectsText}` +
                        `\n// ${detail.description}`
                    );
                });
                
                let interactionsSection;
                if (significantInteractions.length > 0) {
                    const interactionsCode = significantInteractions.map(interaction => {
                        const effect1 = interaction.effects[0];
                        const effect2 = interaction.effects[1];
                        const score1 = calculatedScores[effect1] || 0;
                        const score2 = calculatedScores[effect2] || 0;
                        
                        let modificationCode;
                        if (interaction.modifies && interaction.modifies.length > 0) {
                            modificationCode = interaction.modifies.map(mod => 
                                `scores['${mod.target}'] += ${interaction.strength.toFixed(2)} * ${mod.modifier} = ${(interaction.strength * mod.modifier).toFixed(2)}`
                            ).join('\n');
                        } else {
                            modificationCode = `// Mutual reinforcement
scores['${effect1}'] += ${interaction.strength.toFixed(2)} * 0.2 = ${(interaction.strength * 0.2).toFixed(2)}
scores['${effect2}'] += ${interaction.strength.toFixed(2)} * 0.2 = ${(interaction.strength * 0.2).toFixed(2)}`;
                        }
                        
                        return `// ${effect1} (${score1.toFixed(1)}) + ${effect2} (${score2.toFixed(1)})
// Interaction: "${interaction.name}"
interactionStrength = Math.min(${score1.toFixed(1)}, ${score2.toFixed(1)}) * ${config.get('interactionStrengthFactor')} = ${interaction.strength.toFixed(2)}
${modificationCode}`;
                    }).join('\n\n');
                    
                    interactionsSection = `\`\`\`javascript
// Significant interaction calculations
${interactionsCode}
\`\`\``;
                } else {
                    interactionsSection = `\`\`\`
// No significant interactions found between top effects
// This is because no effects exceed the supportingEffectThreshold (${config.get('supportingEffectThreshold')})
// or no interaction definitions exist between top effects
\`\`\``;
                }
                
                const expectedMatch = topSynergisticEffects[0][0] === tea.expectedEffects?.dominant ? 
                    '✓ Dominant effect matches expected' : '✗ Dominant effect different from expected';
                    
                let keyInteractions = '';
                if (significantInteractions.length > 0) {
                    const interactionList = significantInteractions.slice(0, 2).map(int => 
                        `  * ${int.effects.join(' + ')} → "${int.name}"`
                    ).join('\n');
                    
                    keyInteractions = `- **Key Interactions:** 
${interactionList}`;
                } else {
                    keyInteractions = '- **No significant interactions detected**';
                }
                
                const topEffectsText = topSynergisticEffects.map(([effect, score]) => 
                    `${effect} (${score.toFixed(1)})`
                ).join(', ');
                
                const categories = processingCalculator.categorizeProcessingMethods(tea.processingMethods);
                const processingAnalysis = processingCalculator.getProcessingAnalysis(tea);
                
                const processingCode = [];
                processingDetails.forEach(detail => {
                    const effectsText = Object.entries(detail.effects)
                        .sort((a, b) => b[1] - a[1])
                        .map(([effect, strength]) => `${effect}: ${strength.toFixed(1)}`)
                        .join(', ');
                    
                    processingCode.push(
                        `// ${detail.method} (${detail.category}, intensity: ${detail.intensity.toFixed(1)})` + 
                        `\n// Effects: ${effectsText}` +
                        `\n// ${detail.description}`
                    );
                });
                
                const summaryTable = `
<table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
  <thead>
    <tr style="background-color: #f1f3f4;">
      <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Effect Comparison</th>
      <th style="padding: 8px; text-align: center; border: 1px solid #ddd;">Expected Effects</th>
      <th style="padding: 8px; text-align: center; border: 1px solid #ddd;">Calculated Base Effects</th>
      <th style="padding: 8px; text-align: center; border: 1px solid #ddd;">Final Modified Effects</th>
      <th style="padding: 8px; text-align: center; border: 1px solid #ddd;">Δ Change</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="padding: 8px; text-align: left; border: 1px solid #ddd;"><strong>Dominant Effect</strong></td>
      <td style="padding: 8px; text-align: center; border: 1px solid #ddd;">
        ${tea.expectedEffects?.dominant || 'N/A'}
      </td>
      <td style="padding: 8px; text-align: center; border: 1px solid #ddd;">
        ${topSynergisticEffects[0] ? 
          (calculatedScores[topSynergisticEffects[0][0]] > 0 ? 
            `${topSynergisticEffects[0][0]} (${calculatedScores[topSynergisticEffects[0][0]].toFixed(1)})` : 
            '(Not in base effects)') : 
          'N/A'}
      </td>
      <td style="padding: 8px; text-align: center; border: 1px solid #ddd; font-weight: bold;">
        ${topSynergisticEffects[0] ? `${topSynergisticEffects[0][0]} (${topSynergisticEffects[0][1].toFixed(1)})` : 'N/A'}
      </td>
      <td style="padding: 8px; text-align: center; border: 1px solid #ddd; ${topSynergisticEffects[0] && synergisticContributions[topSynergisticEffects[0][0]] !== 0 ? (synergisticContributions[topSynergisticEffects[0][0]] > 0 ? 'color: green;' : 'color: red;') : ''}">
        ${topSynergisticEffects[0] ? 
          (synergisticContributions[topSynergisticEffects[0][0]] > 0 ? 
            `+${synergisticContributions[topSynergisticEffects[0][0]].toFixed(1)}` : 
            `${synergisticContributions[topSynergisticEffects[0][0]].toFixed(1)}`) : 
          'N/A'}
      </td>
    </tr>
    <tr>
      <td style="padding: 8px; text-align: left; border: 1px solid #ddd;"><strong>Supporting Effect</strong></td>
      <td style="padding: 8px; text-align: center; border: 1px solid #ddd;">
        ${tea.expectedEffects?.supporting || 'N/A'}
      </td>
      <td style="padding: 8px; text-align: center; border: 1px solid #ddd;">
        ${topSynergisticEffects[1] ? 
          (calculatedScores[topSynergisticEffects[1][0]] > 0 ? 
            `${topSynergisticEffects[1][0]} (${calculatedScores[topSynergisticEffects[1][0]].toFixed(1)})` : 
            '(Not in base effects)') : 
          'N/A'}
      </td>
      <td style="padding: 8px; text-align: center; border: 1px solid #ddd; font-weight: bold;">
        ${topSynergisticEffects[1] ? `${topSynergisticEffects[1][0]} (${topSynergisticEffects[1][1].toFixed(1)})` : 'N/A'}
      </td>
      <td style="padding: 8px; text-align: center; border: 1px solid #ddd; ${topSynergisticEffects[1] && synergisticContributions[topSynergisticEffects[1][0]] !== 0 ? (synergisticContributions[topSynergisticEffects[1][0]] > 0 ? 'color: green;' : 'color: red;') : ''}">
        ${topSynergisticEffects[1] ? 
          (synergisticContributions[topSynergisticEffects[1][0]] > 0 ? 
            `+${synergisticContributions[topSynergisticEffects[1][0]].toFixed(1)}` : 
            `${synergisticContributions[topSynergisticEffects[1][0]].toFixed(1)}`) : 
          'N/A'}
      </td>
    </tr>
    <tr>
      <td style="padding: 8px; text-align: left; border: 1px solid #ddd;"><strong>Tertiary Effect</strong></td>
      <td style="padding: 8px; text-align: center; border: 1px solid #ddd;">-</td>
      <td style="padding: 8px; text-align: center; border: 1px solid #ddd;">
        ${topSynergisticEffects[2] ? 
          (calculatedScores[topSynergisticEffects[2][0]] > 0 ? 
            `${topSynergisticEffects[2][0]} (${calculatedScores[topSynergisticEffects[2][0]].toFixed(1)})` : 
            '(Not in base effects)') : 
          'N/A'}
      </td>
      <td style="padding: 8px; text-align: center; border: 1px solid #ddd; font-weight: bold;">
        ${topSynergisticEffects[2] ? `${topSynergisticEffects[2][0]} (${topSynergisticEffects[2][1].toFixed(1)})` : 'N/A'}
      </td>
      <td style="padding: 8px; text-align: center; border: 1px solid #ddd; ${topSynergisticEffects[2] && synergisticContributions[topSynergisticEffects[2][0]] !== 0 ? (synergisticContributions[topSynergisticEffects[2][0]] > 0 ? 'color: green;' : 'color: red;') : ''}">
        ${topSynergisticEffects[2] ? 
          (synergisticContributions[topSynergisticEffects[2][0]] > 0 ? 
            `+${synergisticContributions[topSynergisticEffects[2][0]].toFixed(1)}` : 
            `${synergisticContributions[topSynergisticEffects[2][0]].toFixed(1)}`) : 
          'N/A'}
      </td>
    </tr>
    <tr style="background-color: ${expectedMatch.startsWith('✓') ? '#e6ffe6' : '#fff0f0'}">
      <td colspan="5" style="padding: 8px; text-align: center; border: 1px solid #ddd;">
        <strong>Match Status:</strong> ${expectedMatch}
      </td>
    </tr>
  </tbody>
</table>`;

                html += `
                <div style="background-color: white; padding: 25px; border-radius: 5px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-top: 20px;">
                    <h2>${tea.name} (${tea.originalName})</h2>
                    <p><strong>Type:</strong> ${tea.type} | <strong>Origin:</strong> ${tea.origin}</p>
                    
                    <h3>Effect Summary Comparison</h3>
                    ${summaryTable}
                    
                    <div style="display: flex; margin-bottom: 15px;">
                        <div style="flex: 1;">
                            <h3>Tea Properties</h3>
                            <p><strong>L-Theanine:</strong> ${tea.lTheanineLevel}/10</p>
                            <p><strong>Caffeine:</strong> ${tea.caffeineLevel}/10</p>
                            <p><strong>Ratio:</strong> ${ratio.toFixed(1)}:1</p>
                        </div>
                        <div style="flex: 1;">
                            <h3>Expected Effects</h3>
                            <p><strong>Dominant:</strong> ${tea.expectedEffects?.dominant || 'N/A'}</p>
                            <p><strong>Supporting:</strong> ${tea.expectedEffects?.supporting || 'N/A'}</p>
                            <p><strong>Result:</strong> ${expectedMatch}</p>
                        </div>
                    </div>
                    
                    <h3>Effect Score Breakdown</h3>
                    ${contributionTable}
                    
                    <h3>Geographical Influences</h3>
                    ${geographyDescriptionTable}
                    ${geographyTable}
                    
                    <h3>Compound Factor Analysis</h3>
                    ${compoundTable}
                    
                    <h3>Processing Analysis</h3>
                    <p>${processingAnalysis.description}</p>
                    <p><strong>Categories:</strong> ${Object.keys(processingAnalysis.methodCategories).join(', ')}</p>
                    ${processingTable}
                    
                    <h3>Flavor Profile Influences</h3>
                    <p><strong>Flavors:</strong> ${tea.flavorProfile.join(', ')}</p>
                    ${flavorContributionsTable}
                    
                    <h3>Synergistic Interactions</h3>
                    ${interactionsTable}
                    
                    <div class="code-block" style="white-space: pre-wrap; font-family: monospace; line-height: 1.5;">
### Calculation Steps

#### Step 1: Calculate Base Effects from Properties
\`\`\`javascript
// From generateTeaEffectScores() function
// Start with expected effects
scores['${tea.expectedEffects?.dominant}'] = 8.5;
scores['${tea.expectedEffects?.supporting}'] = 6.5;

// Apply L-Theanine/Caffeine ratio effects
${highRatioEffects}

${lowRatioEffects}

// Apply geographical effects
${geographyCalculator.getEffectsCalculationText(tea.origin)}

// Apply compound effects
// L-Theanine/Caffeine Ratio: ${ratio.toFixed(2)}
// Polyphenol Estimate: ${estimatePolyphenols(tea).toFixed(1)}/10
// Amino Acid Profile: ${estimateAminoAcids(tea).toFixed(1)}/10
${getCompoundCalculationText(tea)}

// Apply processing method effects
${processingCode.join('\n\n')}

// Apply flavor influences
${tea.flavorProfile.length > 0 
  ? '// Calculate effects from tea flavors:\n' + tea.flavorProfile.map(flavor => {
      const details = getFlavorDetails([flavor])[0];
      if (!details) return `// No data found for flavor: ${flavor}`;
      return `// ${flavor} (${details.category}/${details.subcategory}, intensity: ${details.intensity})
// Effects: ${details.effects.join(', ')}`;
    }).join('\n')
  : '// No flavor profile data available'
}
\`\`\`

#### Step 2: Synergistic Effects Calculation
${interactionsSection}
                    </div>
                </div>`;
            });
            
            document.getElementById('test-results').innerHTML = html;
        }
        
        function renderTeaInfo(tea) {
            if (!tea) return '<p>Tea data not available</p>';
            
            const ratio = (tea.lTheanineLevel / tea.caffeineLevel).toFixed(2);
            
            return `
                <div class="tea-info">
                    <h4>${tea.name} (${tea.originalName})</h4>
                    <p><strong>Type:</strong> ${tea.type} | <strong>Origin:</strong> ${tea.origin}</p>
                    
                    <div class="tea-property">
                        <span>L-Theanine:</span>
                        <span>${tea.lTheanineLevel}/10</span>
                    </div>
                    <div class="tea-property">
                        <span>Caffeine:</span>
                        <span>${tea.caffeineLevel}/10</span>
                    </div>
                    <div class="tea-property">
                        <span>Ratio:</span>
                        <span>${ratio}:1</span>
                    </div>
                    
                    <div class="tea-ratio">
                        <div class="l-theanine-bar" style="width: ${(tea.lTheanineLevel / 10) * 100}%"></div>
                        <div class="caffeine-bar" style="width: ${(tea.caffeineLevel / 10) * 100}%"></div>
                    </div>
                    
                    <h4>Flavor Profile</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${tea.flavorProfile.map(flavor => 
                            `<span style="background: #e9ecef; padding: 2px 8px; border-radius: 12px; font-size: 14px;">${flavor}</span>`
                        ).join('')}
                    </div>
                </div>
            `;
        }
        
        function renderScores(scores) {
            return `
                <div>
                    ${Object.entries(scores)
                        .sort((a, b) => b[1] - a[1])
                        .map(([effect, score]) => `
                            <div class="effect-label">
                                <span>${effect}</span>
                                <span>${score.toFixed(1)}</span>
                            </div>
                            <div class="effect-bar">
                                <div class="effect-bar-fill" style="width: ${Math.min(100, score * 10)}%"></div>
                            </div>
                        `).join('')
                    }
                </div>
            `;
        }
        
        function calculateFlavorContributions(flavorProfile) {
            if (!Array.isArray(flavorProfile) || flavorProfile.length === 0) {
                return {};
            }
            
            const effectScores = {};
            
            const effectMatches = {};
            
            flavorProfile.forEach(flavor => {
                for (const category in flavorInfluences) {
                    for (const subcategory in flavorInfluences[category]) {
                        const subcategoryData = flavorInfluences[category][subcategory];
                        
                        if (subcategoryData.flavors.includes(flavor.toLowerCase())) {
                            subcategoryData.effects.forEach(effect => {
                                effectMatches[effect] = (effectMatches[effect] || 0) + 1;
                                
                                const diminishingFactor = 1 / Math.sqrt(effectMatches[effect]);
                                
                                effectScores[effect] = (effectScores[effect] || 0) + 
                                    subcategoryData.intensity * diminishingFactor;
                            });
                            
                            break;
                        }
                    }
                }
            });
            
            return effectScores;
        }
        
        function getFlavorDetails(flavorProfile) {
            if (!Array.isArray(flavorProfile) || flavorProfile.length === 0) {
                return [];
            }
            
            const details = [];
            
            flavorProfile.forEach(flavor => {
                for (const category in flavorInfluences) {
                    for (const subcategory in flavorInfluences[category]) {
                        const subcategoryData = flavorInfluences[category][subcategory];
                        
                        if (subcategoryData.flavors.includes(flavor.toLowerCase())) {
                            details.push({
                                name: flavor,
                                category: category,
                                subcategory: subcategory,
                                intensity: subcategoryData.intensity,
                                effects: subcategoryData.effects
                            });
                            
                            break;
                        }
                    }
                }
            });
            
            return details;
        }
        
        function calculateCompoundEffects(tea) {
            const scores = {};
            
            const polyphenols = estimatePolyphenols(tea);
            if (polyphenols > 7) {
                scores.clarifying = 1.5 + (polyphenols - 7) * 0.5;
            } else if (polyphenols > 5) {
                scores.clarifying = (polyphenols - 5) * 0.75;
            }
            
            if (polyphenols > 6) {
                scores.restorative = (polyphenols - 6) * 0.5;
            }
            
            const aminoAcids = estimateAminoAcids(tea);
            if (aminoAcids > 7) {
                scores.soothing = 1.2 + (aminoAcids - 7) * 0.4;
            } else if (aminoAcids > 5) {
                scores.soothing = (aminoAcids - 5) * 0.6;
            }
            
            if (aminoAcids > 6) {
                scores.nurturing = (aminoAcids - 6) * 0.5;
            }
            
            return scores;
        }
        
        function estimatePolyphenols(tea) {
            let base = 5;
            
            if (tea.type.toLowerCase().includes('green')) base += 2;
            else if (tea.type.toLowerCase().includes('white')) base += 1;
            else if (tea.type.toLowerCase().includes('oolong')) base += 0.5;
            else if (tea.type.toLowerCase().includes('black')) base -= 0.5;
            else if (tea.type.toLowerCase().includes('puerh')) base -= 1;
            
            if (tea.processingMethods.includes('minimal-processing')) base += 1;
            if (tea.processingMethods.includes('shade-grown')) base += 1.5;
            if (tea.processingMethods.includes('heavy-roast')) base -= 1;
            if (tea.processingMethods.includes('aged')) base -= 0.5;
            
            return Math.min(10, Math.max(1, base));
        }
        
        function estimateAminoAcids(tea) {
            let base = tea.lTheanineLevel * 0.7;
            
            if (tea.type.toLowerCase().includes('green')) base += 1;
            else if (tea.type.toLowerCase().includes('white')) base += 1.5;
            else if (tea.type.toLowerCase().includes('oolong')) base += 0.5;
            
            if (tea.processingMethods.includes('shade-grown')) base += 1.5;
            if (tea.processingMethods.includes('minimal-processing')) base += 1;
            if (tea.processingMethods.includes('heavy-roast')) base -= 1;
            
            return Math.min(10, Math.max(1, base));
        }
        
        function getCompoundCalculationText(tea) {
            const polyphenols = estimatePolyphenols(tea);
            const aminoAcids = estimateAminoAcids(tea);
            const effects = calculateCompoundEffects(tea);
            
            if (Object.keys(effects).length === 0) {
                return '// No significant compound effects detected';
            }
            
            let text = `// Polyphenol content: ${polyphenols.toFixed(1)}/10\n`;
            text += `// Amino acid content: ${aminoAcids.toFixed(1)}/10\n`;
            
            Object.entries(effects).forEach(([effect, value]) => {
                if (effect === 'clarifying' || effect === 'restorative') {
                    text += `scores['${effect}'] += ${value.toFixed(1)}; // polyphenol influence\n`;
                } else if (effect === 'soothing' || effect === 'nurturing') {
                    text += `scores['${effect}'] += ${value.toFixed(1)}; // amino acid influence\n`;
                }
            });
            
            return text;
        }
        
        function getRatioDescription(ratio) {
            if (ratio > 2.0) {
                return 'Very high L-Theanine to Caffeine ratio promotes strong peaceful and soothing effects';
            } else if (ratio > 1.5) {
                return 'High L-Theanine to Caffeine ratio enhances peaceful and soothing effects';
            } else if (ratio > 1.0) {
                return 'Balanced L-Theanine to Caffeine ratio provides even energy without jitters';
            } else if (ratio > 0.5) {
                return 'Low L-Theanine to Caffeine ratio creates more stimulating effects with some calming balance';
            } else {
                return 'Very low L-Theanine to Caffeine ratio results in strong stimulating effects';
            }
        }
        
        function getPolyphenolDescription(level) {
            if (level > 8) {
                return 'Exceptionally high polyphenol content provides pronounced clarifying and antioxidant properties';
            } else if (level > 6) {
                return 'High polyphenol content enhances clarifying and restorative effects';
            } else if (level > 4) {
                return 'Moderate polyphenol content provides balanced clarifying properties';
            } else {
                return 'Lower polyphenol content results in milder clarifying effects';
            }
        }
        
        function getAminoAcidDescription(level) {
            if (level > 8) {
                return 'Exceptionally high amino acid content provides pronounced soothing and umami qualities';
            } else if (level > 6) {
                return 'High amino acid content enhances soothing and nurturing effects';
            } else if (level > 4) {
                return 'Moderate amino acid content provides balanced soothing properties';
            } else {
                return 'Lower amino acid content results in milder soothing effects';
            }
        }
    </script>
</body>
</html> 